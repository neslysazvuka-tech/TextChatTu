<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ephemeral Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <div class="auth-overlay" id="authOverlay">
      <div class="auth-box">
        <h2>Добро пожаловать</h2>
        <p>Введите имя пользователя для входа в чат</p>
        <input type="text" id="usernameInput" placeholder="Ваше имя" maxlength="20">
        <button id="loginBtn">Войти в чат</button>
      </div>
    </div>

    <div class="chat-container" id="chatContainer">
      <header class="chat-header">
        <h1>Ephemeral Chat</h1>
        <p>Сообщения исчезают через 1 минуту</p>
        <div class="user-info">
          <span id="currentUsername"></span>
          <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </header>

      <div class="messages-container" id="messagesContainer">
        <!-- Сообщения будут здесь -->
      </div>

      <div class="message-input-container">
        <input type="text" id="messageInput" placeholder="Напишите сообщение..." maxlength="200">
        <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onChildAdded, onChildRemoved, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA3SljggTgEvubdSSpat4FovC5q0LmR10U",
      authDomain: "textchattu.firebaseapp.com",
      databaseURL: "https://textchattu-default-rtdb.firebaseio.com",
      projectId: "textchattu",
      storageBucket: "textchattu.firebasestorage.app",
      messagingSenderId: "200660975016",
      appId: "1:200660975016:web:0777dc361c70162bca319d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // DOM элементы
    const authOverlay = document.getElementById('authOverlay');
    const chatContainer = document.getElementById('chatContainer');
    const usernameInput = document.getElementById('usernameInput');
    const loginBtn = document.getElementById('loginBtn');
    const currentUsername = document.getElementById('currentUsername');
    const logoutBtn = document.getElementById('logoutBtn');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    // Переменные состояния
    let username = '';
    let messagesRef = null;
    let userMessagesRef = null;

    // Инициализация приложения
    function init() {
      // Проверяем, есть ли сохраненное имя пользователя
      const savedUsername = localStorage.getItem('chatUsername');
      if (savedUsername) {
        username = savedUsername;
        startChat();
      } else {
        showAuthOverlay();
      }
      
      // Настройка обработчиков событий
      setupEventListeners();
    }

    // Показать окно авторизации
    function showAuthOverlay() {
      authOverlay.style.display = 'flex';
      chatContainer.style.display = 'none';
      usernameInput.focus();
    }

    // Скрыть окно авторизации
    function hideAuthOverlay() {
      authOverlay.style.display = 'none';
      chatContainer.style.display = 'flex';
    }

    // Настройка обработчиков событий
    function setupEventListeners() {
      // Вход в чат
      loginBtn.addEventListener('click', handleLogin);
      usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });
      
      // Выход из чата
      logoutBtn.addEventListener('click', handleLogout);
      
      // Отправка сообщения
      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // Обработка входа
    function handleLogin() {
      const inputUsername = usernameInput.value.trim();
      
      if (inputUsername === '') {
        alert('Пожалуйста, введите имя пользователя');
        return;
      }
      
      if (inputUsername.length > 20) {
        alert('Имя пользователя должно быть не длиннее 20 символов');
        return;
      }
      
      username = inputUsername;
      localStorage.setItem('chatUsername', username);
      usernameInput.value = '';
      hideAuthOverlay();
      startChat();
    }

    // Обработка выхода
    function handleLogout() {
      // Удаляем все сообщения пользователя
      if (userMessagesRef) {
        remove(userMessagesRef)
          .then(() => {
            console.log('Все сообщения пользователя удалены');
          })
          .catch((error) => {
            console.error('Ошибка при удалении сообщений:', error);
          });
      }
      
      // Сбрасываем состояние
      username = '';
      localStorage.removeItem('chatUsername');
      if (messagesRef) {
        // Отключаем все слушатели
        // В новой версии Firebase нет явного метода off(), поэтому просто обнуляем ссылки
        messagesRef = null;
        userMessagesRef = null;
      }
      
      // Очищаем чат
      messagesContainer.innerHTML = '';
      
      // Показываем окно авторизации
      showAuthOverlay();
    }

    // Запуск чата
    function startChat() {
      currentUsername.textContent = username;
      
      // Ссылки на базу данных
      messagesRef = ref(database, 'messages');
      userMessagesRef = ref(database, 'userMessages/' + encodeUsername(username));
      
      // Загрузка сообщений
      loadMessages();
      
      // Фокус на поле ввода сообщения
      messageInput.focus();
    }

    // Кодирование имени пользователя для Firebase
    function encodeUsername(username) {
      return username.replace(/\./g, ',').replace(/\$/g, '&dollar;').replace(/#/g, '&hash;').replace(/\[/g, '&lbracket;').replace(/\]/g, '&rbracket;');
    }

    // Декодирование имени пользователя из Firebase
    function decodeUsername(encoded) {
      return encoded.replace(/&rbracket;/g, ']').replace(/&lbracket;/g, '[').replace(/&hash;/g, '#').replace(/&dollar;/g, '$').replace(/,/g, '.');
    }

    // Загрузка сообщений
    function loadMessages() {
      onChildAdded(messagesRef, (snapshot) => {
        const message = snapshot.val();
        addMessageToChat(message, false);
        
        // Прокрутка вниз при новом сообщении
        scrollToBottom();
      });
      
      // Обработка удаления сообщений
      onChildRemoved(messagesRef, (snapshot) => {
        const messageId = snapshot.key;
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
          messageElement.classList.add('deleting');
          setTimeout(() => {
            messageElement.remove();
          }, 500);
        }
      });
    }

    // Добавление сообщения в чат
    function addMessageToChat(message, isSent) {
      // Проверяем, не существует ли уже это сообщение
      if (document.getElementById(message.id)) return;
      
      const messageElement = document.createElement('div');
      messageElement.id = message.id;
      messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
      
      const messageInfo = document.createElement('div');
      messageInfo.className = 'message-info';
      messageInfo.innerHTML = `
        <span class="sender">${message.sender}</span>
      `;
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = message.text;
      
      const messageTime = document.createElement('div');
      messageTime.className = 'message-time';
      messageTime.textContent = formatTime(message.timestamp);
      
      messageElement.appendChild(messageInfo);
      messageElement.appendChild(messageContent);
      messageElement.appendChild(messageTime);
      
      messagesContainer.appendChild(messageElement);
      
      // Запланировать удаление сообщения через 1 минуту
      if (isSent) {
        scheduleMessageDeletion(message.id);
      }
    }

    // Форматирование времени
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Отправка сообщения
    function sendMessage() {
      const messageText = messageInput.value.trim();
      
      if (messageText === '') {
        return;
      }
      
      if (messageText.length > 200) {
        alert('Сообщение должно быть не длиннее 200 символов');
        return;
      }
      
      // Создаем объект сообщения
      const message = {
        id: generateMessageId(),
        sender: username,
        text: messageText,
        timestamp: Date.now(),
        userId: encodeUsername(username)
      };
      
      // Сохраняем сообщение в общую ветку
      set(ref(database, `messages/${message.id}`), message)
        .then(() => {
          // Также сохраняем в ветку пользователя для последующего удаления при выходе
          set(ref(database, `userMessages/${encodeUsername(username)}/${message.id}`), true);
          
          // Добавляем сообщение в чат сразу (не ждем Firebase)
          addMessageToChat(message, true);
          
          // Очищаем поле ввода
          messageInput.value = '';
          
          // Прокрутка вниз
          scrollToBottom();
        })
        .catch((error) => {
          console.error('Ошибка при отправке сообщения:', error);
          alert('Не удалось отправить сообщение. Пожалуйста, попробуйте снова.');
        });
    }

    // Генерация ID сообщения
    function generateMessageId() {
      return 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Запланировать удаление сообщения
    function scheduleMessageDeletion(messageId) {
      setTimeout(() => {
        remove(ref(database, `messages/${messageId}`))
          .catch((error) => {
            console.error('Ошибка при удалении сообщения:', error);
          });
      }, 60000); // 1 минута
    }

    // Прокрутка вниз
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Запуск приложения при загрузке страницы
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
